<article class="editor-area">
<div class="editor-area" id="noteIFrameContent"><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">MQ: Message Queue</span> </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;font-weight:bold;">一些常用的命令:</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">1. RabbitMQ Server</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><a href="http://www.rabbitmq.com/download.html"><span style="color:#003884;text-decoration:underline;">http://www.rabbitmq.com/download.html</span></a> </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">2. Run RabbitMQ Server</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">sudo rabbitmq-server</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">3. Listing queues</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">sudo rabbitmqctl list_queues</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">4. print the messages_unacknowledged field:</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">5. 关闭server </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">sudo rabbitmqctl stop</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:22px;font-weight:bold;">官方教程 1~5: </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;font-weight:bold;">1) Hello world </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">1. Establish connection --&gt; 获得一个<span style="font-weight:bold;">channel</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">2. channel.queue_declare --&gt; 新建一个<span style="font-weight:bold;">queue</span> </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">3. <span style="font-weight:bold;">receiver</span> 是一个while loop接收message </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;font-weight:bold;">2) Work queue</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">Task(封装为message) --&gt; push到queue里 --&gt; workers pop msg --&gt; execute task</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">    Round robin: 比如有三个workers的话, 同时处理三个tasks</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Message acknowledgement: </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">保证 当某个worker挂掉的话, 不丢失消息. </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">worker --&gt; die(without sending ack) --&gt; requeue msg </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Forgotten acknowledgment</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">没有给channel加basic_ack的话, 也会重新分配给其他workers, 但也会保存messages_unacknowledged.  </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">RabbitMQ will eat more and more memory as it won't be able to <span style="font-weight:bold;">release any unacked messages.</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">_</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Debug: </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Message durability</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">就算server重启了, queue和message也不会丢失.  </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">channel.queue_declare(queue='hello', <span style="font-weight:bold;">durable=True</span>)</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Fair dispatch</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">默认的话是平均分配message, 举个例子:</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">task 1: 10s</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">taks 2: 1s </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">taks 3: 1s </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">taks 4: 1s </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">_</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">worker1: t1, t3</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">worker2: t2, t4</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">结果就是t3 被堵塞住了.       </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">_</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Solution:    </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">channel.basic_qos(prefetch_count=1)</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">意思就是告诉server给每个worker分配的message不要超过<span style="font-weight:bold;">一个.  </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">也就是说 在worker解决一个task前不要给它分配任务.     </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;font-weight:bold;">3) Publish/Subscribe</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Exchange types: </span>direct, topic, headers and fanout</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">Secondly, once we disconnect the consumer the queue should be deleted. There's an exclusive flag for that:</span></div><div style="white-space: pre-wrap;line-height:1.75;text-align:left;line-height:1.75;" yne-bulb-block="paragraph">result = channel.queue_declare(exclusive=True)</div><div yne-bulb-block="image"><img alt="" src="images/replace-img.png" data-media-type="image" data-original="http://www.rabbitmq.com/img/tutorials/python-three-overall.png" style="cursor: pointer;"></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;color:#393939;font-weight:bold;">4) Routing</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:13px;color:#008080;background-color:#eeeeee;">channel</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_bind</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">(</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange_name</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                   </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_name</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                   </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;font-weight:bold;">routing_key</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#dd1144;background-color:#eeeeee;font-weight:bold;">'black'</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">)</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">routing key 就是"orange", "black", "green", </div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">exchange的type设成direct的时候, 它就会根据message的binding key来分配msg到特定的queue.</div><div yne-bulb-block="image"><img alt="" src="images/replace-img.png" data-media-type="image" data-original="http://www.rabbitmq.com/img/tutorials/direct-exchange.png" style="cursor: pointer;"></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">要是binding key都一样的话, 就是广播了(<span style="font-weight:bold;">fanout</span>)</div><div yne-bulb-block="image"><img alt="" src="images/replace-img.png" data-media-type="image" data-original="http://www.rabbitmq.com/img/tutorials/direct-exchange-multiple.png" style="cursor: pointer;"></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">发送信息: </span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">1. 定义一个exchange</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:13px;color:#008080;background-color:#eeeeee;">channel</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange_declare</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">(</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#dd1144;background-color:#eeeeee;">'direct_logs'</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                         </span><span style="font-size:13px;color:#0086b3;background-color:#eeeeee;">type</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#dd1144;background-color:#eeeeee;">'direct'</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">)</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">2. 发送信息</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:13px;color:#008080;background-color:#eeeeee;">channel</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">basic_publish</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">(</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#dd1144;background-color:#eeeeee;">'direct_logs'</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                      </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;font-weight:bold;">routing_key</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;font-weight:bold;">severity</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">,</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">
                      </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">body</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">message</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">)</span></div><div style="white-space: pre-wrap;line-height:1.75;text-align:left;line-height:1.75;" yne-bulb-block="paragraph">routing_key就是刚刚的"orange", "black", etc.</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">接收信息:</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:13px;color:#008080;background-color:#eeeeee;">result</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">channel</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_declare</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">(</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exclusive</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#999999;background-color:#eeeeee;">True</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">)
</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_name</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">result</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">method</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">

</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">for</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">severity</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">in</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;"> </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">severities</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">:
    </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">channel</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">.</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_bind</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">(</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">exchange</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#dd1144;background-color:#eeeeee;">'direct_logs'</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                       </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">queue_name</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">,
                       </span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">routing_key</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;font-weight:bold;">=</span><span style="font-size:13px;color:#008080;background-color:#eeeeee;">severity</span><span style="font-size:13px;color:#555555;background-color:#eeeeee;">)</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-size:18px;font-weight:bold;">5) Topics exchange</span></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph">* (star) can substitute for exactly one word.</div><div style="white-space: pre-wrap;line-height:1.75;text-align:left;line-height:1.75;" yne-bulb-block="paragraph"># (hash) can substitute for zero or more words.</div><div yne-bulb-block="image"><img alt="" src="images/replace-img.png" data-media-type="image" data-original="http://www.rabbitmq.com/img/tutorials/python-five.png" style="cursor: pointer;"></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">You can create multiple bindings:</span></div><div style="white-space: pre-wrap;line-height:1.75;text-align:left;line-height:1.75;" yne-bulb-block="paragraph">python receive_logs_topic.py "kern.*" "*.critical"</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><span style="font-weight:bold;">emit a log with a routing key "kern.critical" type:</span></div><div style="white-space: pre-wrap;line-height:1.75;text-align:left;line-height:1.75;" yne-bulb-block="paragraph">python emit_log_topic.py "kern.critical" "A critical kernel error"</div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div><div style="white-space: pre-wrap;" yne-bulb-block="paragraph"><br></div></div>


</article>
